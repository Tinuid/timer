<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ff6b35">
    <meta name="description" content="Timer für Dehnübungen mit Wiederholungen">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="assets/icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="assets/icons/icon-512.png">
    <link rel="manifest" href="manifest.json">
    <title>Dehnübungen Timer</title>

    <style>
        :root {
            --primary: #ff6b35;
            --primary-dark: #e55a25;
            --accent: #ffa07a;
            --accent-dark: #ff8c5a;
            --bg: #0a0a0a;
            --bg-card: #1a1a1a;
            --text: #ffffff;
            --text-light: #a0a0a0;
            --border: #2a2a2a;
            --ring-bg: #2a2a2a;
            --danger: #ef4444;
            --warning: #f59e0b;

            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;

            --radius: 12px;
            --radius-lg: 16px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
            touch-action: manipulation;
            margin: 0;
            padding: 0;
        }

        main {
            flex: 1;
            padding: var(--spacing-md) var(--spacing-sm);
            width: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .settings-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            box-shadow: var(--shadow);
            z-index: 100;
            font-size: 24px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .settings-fab:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .settings-fab:active {
            transform: scale(0.95);
        }

        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-md);
        }

        .settings-modal.active {
            display: flex;
        }

        .settings-content {
            background: var(--bg-card);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
        }

        .close-btn {
            background: transparent;
            border: none;
            color: var(--text-light);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
            min-height: auto;
        }

        .close-btn:hover {
            background: var(--border);
            color: var(--text);
        }

        .setting-group {
            margin-bottom: var(--spacing-md);
        }

        .setting-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-light);
            margin-bottom: var(--spacing-xs);
        }

        input[type="number"],
        select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            background: #1a1a1a;
            color: var(--text);
            transition: border-color 0.2s ease;
        }

        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
        }

        option {
            background: #1a1a1a;
            color: var(--text);
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: var(--primary-dark);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
        }

        .volume-display {
            text-align: right;
            font-size: 0.875rem;
            color: var(--text-light);
            margin-top: var(--spacing-xs);
        }

        .presets-section {
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--border);
        }

        .presets-section h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: var(--spacing-sm);
        }

        .preset-save-form {
            display: flex;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-sm);
        }

        .preset-save-form input[type="text"] {
            flex: 1;
            padding: 0.6rem 0.75rem;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.9rem;
            background: #1a1a1a;
            color: var(--text);
            transition: border-color 0.2s ease;
        }

        .preset-save-form input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
        }

        .preset-save-form input[type="text"]::placeholder {
            color: var(--text-light);
        }

        .btn-save-preset {
            padding: 0.6rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
            min-height: auto;
        }

        .btn-save-preset:hover {
            background: var(--primary-dark);
        }

        .presets-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            max-height: 200px;
            overflow-y: auto;
        }

        .preset-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--bg);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            transition: border-color 0.2s ease;
        }

        .preset-item:hover {
            border-color: var(--primary);
        }

        .preset-info {
            flex: 1;
            cursor: pointer;
        }

        .preset-name {
            font-weight: 500;
            color: var(--text);
            margin-bottom: 2px;
        }

        .preset-details {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .btn-delete-preset {
            padding: 0.4rem 0.6rem;
            background: transparent;
            color: var(--text-light);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: auto;
        }

        .btn-delete-preset:hover {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        .no-presets {
            color: var(--text-light);
            font-size: 0.875rem;
            text-align: center;
            padding: var(--spacing-sm);
        }

        .timer-display {
            text-align: center;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-md);
        }

        .circular-timer {
            position: relative;
            width: min(90vw, 90vh);
            height: min(90vw, 90vh);
            max-width: 500px;
            max-height: 500px;
        }

        .timer-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .circular-timer svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .circle-bg {
            fill: none;
            stroke: var(--ring-bg);
            stroke-width: 12;
        }

        .circle-progress {
            fill: none;
            stroke: var(--primary);
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.3s ease, stroke 0.3s ease;
        }

        .circle-progress.in-break {
            stroke: var(--accent);
        }

        .circle-progress.paused {
            stroke: var(--warning);
        }

        .countdown {
            font-size: clamp(3rem, 12vw, 6rem);
            font-weight: 700;
            color: var(--text);
            font-variant-numeric: tabular-nums;
            line-height: 1;
        }

        .countdown.paused {
            color: var(--warning);
        }

        .countdown.in-break {
            color: var(--accent);
        }

        .timer-status {
            font-size: 1.2rem;
            margin-top: 0.5rem;
            color: var(--text-light);
        }

        .timer-status.in-break {
            color: var(--accent);
        }

        .repetition-counter {
            font-size: 1.5rem;
            color: var(--text);
            text-align: center;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            width: 100%;
            max-width: 400px;
        }

        button {
            padding: 1rem;
            border: none;
            border-radius: var(--radius);
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 56px;
            touch-action: manipulation;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 12px 20px rgba(255, 107, 53, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary.running {
            background: var(--danger);
        }

        .btn-primary.running:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #2a2a2a;
            color: var(--text);
            border: 1px solid #3a3a3a;
        }

        .btn-secondary:hover {
            background: #333333;
        }

        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary:disabled:hover {
            background: #2a2a2a;
            transform: none;
        }

        .secondary-controls {
            display: flex;
            gap: var(--spacing-sm);
        }

        .secondary-controls button {
            flex: 1;
        }

        .hidden {
            display: none;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .countdown.pulse {
            animation: pulse 1s ease-in-out infinite;
        }

        @media (max-width: 360px) {
            .settings-fab {
                bottom: 15px;
                right: 15px;
                width: 48px;
                height: 48px;
                font-size: 20px;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }
    </style>
</head>
<body>
    <main>
        <div class="repetition-counter" id="repetitionCounter">Übung 0 / 10</div>

        <div class="timer-display">
            <div class="circular-timer">
                <svg viewBox="0 0 300 300">
                    <circle class="circle-bg" cx="150" cy="150" r="140"></circle>
                    <circle class="circle-progress" id="circleProgress" cx="150" cy="150" r="140"></circle>
                </svg>
                <div class="timer-center">
                    <div class="countdown" id="countdown">01:00</div>
                    <div class="timer-status" id="timerStatus"></div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn-primary" id="startStopBtn">Start</button>
            <div class="secondary-controls">
                <button class="btn-secondary" id="pauseResumeBtn" disabled>Pause</button>
                <button class="btn-secondary" id="resetBtn">Reset</button>
            </div>
        </div>
    </main>

    <button class="settings-fab" id="settingsFab">⚙</button>

    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="modal-header">
                <h2>Einstellungen</h2>
                <button class="close-btn" id="closeSettings">✕</button>
            </div>
            <div class="settings-inputs">
                <div class="setting-group">
                    <label for="timerDuration">Timer-Dauer (Sekunden)</label>
                    <input type="number" id="timerDuration" min="10" max="600" step="5" value="60">
                </div>

                <div class="setting-group">
                    <label for="pauseDuration">Pause zwischen Übungen (Sekunden)</label>
                    <input type="number" id="pauseDuration" min="0" max="60" step="5" value="5">
                </div>

                <div class="setting-group">
                    <label for="repetitions">Anzahl Wiederholungen</label>
                    <input type="number" id="repetitions" min="1" max="50" value="10">
                </div>

                <div class="setting-group">
                    <label for="soundSelect">Ton-Auswahl</label>
                    <select id="soundSelect">
                        <option value="beep">Beep</option>
                        <option value="chime">Chime</option>
                        <option value="bell">Bell</option>
                    </select>
                </div>

                <div class="setting-group">
                    <label for="volume">Lautstärke</label>
                    <input type="range" id="volume" min="0" max="100" value="80">
                    <div class="volume-display"><span id="volumeValue">80</span>%</div>
                </div>
            </div>

            <div class="presets-section">
                <h3>Voreinstellungen</h3>
                <div class="preset-save-form">
                    <input type="text" id="presetName" placeholder="Name der Voreinstellung">
                    <button class="btn-save-preset" id="savePresetBtn">Speichern</button>
                </div>
                <div class="presets-list" id="presetsList">
                    <div class="no-presets">Keine Voreinstellungen gespeichert</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class TimerManager {
            constructor() {
                this.currentTime = 0;
                this.totalTime = 60;
                this.pauseTime = 5;
                this.repetitions = 10;
                this.currentRepetition = 0;
                this.isRunning = false;
                this.isPaused = false;
                this.isInBreak = false;
                this.intervalId = null;
                this.selectedSound = 'beep';
                this.volume = 0.8;

                this.audioContext = null;
                this.sounds = {};
                this.presets = [];

                this.initAudio();
                this.loadSettings();
                this.loadPresets();
                this.bindEvents();
                this.updateDisplay();
            }

            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.warn('Web Audio API not supported');
                }
            }

            async playSound(soundType = 'main') {
                if (this.audioContext) {
                    try {
                        if (this.audioContext.state === 'suspended') {
                            await this.audioContext.resume();
                        }

                        const oscillator = this.audioContext.createOscillator();
                        const gainNode = this.audioContext.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(this.audioContext.destination);

                        let frequency, duration, volume, type;

                        if (soundType === 'breakStart') {
                            // Klingeln für Pausenstart - mehrere Töne hintereinander
                            const ring = async () => {
                                for (let i = 0; i < 3; i++) {
                                    const osc = this.audioContext.createOscillator();
                                    const gain = this.audioContext.createGain();
                                    osc.connect(gain);
                                    gain.connect(this.audioContext.destination);

                                    osc.frequency.value = 1000;
                                    osc.type = 'sine';
                                    gain.gain.setValueAtTime(this.volume * 0.7, this.audioContext.currentTime);
                                    gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);

                                    osc.start(this.audioContext.currentTime + i * 0.25);
                                    osc.stop(this.audioContext.currentTime + i * 0.25 + 0.2);
                                }
                            };
                            await ring();
                            return;
                        } else if (soundType === 'countdown') {
                            // Leiser Beep für Countdown (letzte 3 Sekunden der Pause)
                            frequency = 600;
                            duration = 0.1;
                            volume = this.volume * 0.3;
                            type = 'sine';
                        } else {
                            // Normaler Beep am Ende der Pause/Übung
                            const frequencies = {
                                'beep': 800,
                                'chime': 1200,
                                'bell': 600
                            };
                            frequency = frequencies[this.selectedSound] || 800;
                            duration = 0.5;
                            volume = this.volume;
                            type = this.selectedSound === 'bell' ? 'sine' : 'square';
                        }

                        oscillator.frequency.value = frequency;
                        oscillator.type = type;

                        gainNode.gain.setValueAtTime(volume, this.audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);

                        oscillator.start(this.audioContext.currentTime);
                        oscillator.stop(this.audioContext.currentTime + duration);
                    } catch (e) {
                        console.warn('Could not play sound:', e);
                    }
                }
            }

            vibrate() {
                if ('vibrate' in navigator) {
                    navigator.vibrate([200, 100, 200]);
                }
            }

            loadSettings() {
                try {
                    const settings = JSON.parse(localStorage.getItem('timerSettings') || '{}');

                    this.totalTime = settings.timerDuration || 60;
                    this.pauseTime = settings.pauseDuration || 5;
                    this.repetitions = settings.repetitions || 10;
                    this.selectedSound = settings.selectedSound || 'beep';
                    this.volume = settings.volume !== undefined ? settings.volume : 0.8;

                    document.getElementById('timerDuration').value = this.totalTime;
                    document.getElementById('pauseDuration').value = this.pauseTime;
                    document.getElementById('repetitions').value = this.repetitions;
                    document.getElementById('soundSelect').value = this.selectedSound;
                    document.getElementById('volume').value = this.volume * 100;
                    document.getElementById('volumeValue').textContent = Math.round(this.volume * 100);

                    this.currentTime = this.totalTime;
                } catch (e) {
                    console.warn('Could not load settings:', e);
                }
            }

            saveSettings() {
                const settings = {
                    timerDuration: this.totalTime,
                    pauseDuration: this.pauseTime,
                    repetitions: this.repetitions,
                    selectedSound: this.selectedSound,
                    volume: this.volume
                };

                try {
                    localStorage.setItem('timerSettings', JSON.stringify(settings));
                } catch (e) {
                    console.warn('Could not save settings:', e);
                }
            }

            loadPresets() {
                try {
                    this.presets = JSON.parse(localStorage.getItem('timerPresets') || '[]');
                    this.renderPresets();
                } catch (e) {
                    console.warn('Could not load presets:', e);
                    this.presets = [];
                }
            }

            savePresetsToStorage() {
                try {
                    localStorage.setItem('timerPresets', JSON.stringify(this.presets));
                } catch (e) {
                    console.warn('Could not save presets:', e);
                }
            }

            savePreset() {
                const nameInput = document.getElementById('presetName');
                const name = nameInput.value.trim();

                if (!name) {
                    return;
                }

                const preset = {
                    id: Date.now(),
                    name: name,
                    timerDuration: this.totalTime,
                    pauseDuration: this.pauseTime,
                    repetitions: this.repetitions
                };

                this.presets.push(preset);
                this.savePresetsToStorage();
                this.renderPresets();
                nameInput.value = '';
            }

            loadPreset(presetId) {
                const preset = this.presets.find(p => p.id === presetId);
                if (!preset) return;

                this.totalTime = preset.timerDuration;
                this.pauseTime = preset.pauseDuration;
                this.repetitions = preset.repetitions;

                document.getElementById('timerDuration').value = this.totalTime;
                document.getElementById('pauseDuration').value = this.pauseTime;
                document.getElementById('repetitions').value = this.repetitions;

                if (!this.isRunning) {
                    this.currentTime = this.totalTime;
                }

                this.saveSettings();
                this.updateDisplay();
            }

            deletePreset(presetId) {
                this.presets = this.presets.filter(p => p.id !== presetId);
                this.savePresetsToStorage();
                this.renderPresets();
            }

            renderPresets() {
                const listContainer = document.getElementById('presetsList');

                if (this.presets.length === 0) {
                    listContainer.innerHTML = '<div class="no-presets">Keine Voreinstellungen gespeichert</div>';
                    return;
                }

                listContainer.innerHTML = this.presets.map(preset => `
                    <div class="preset-item" data-preset-id="${preset.id}">
                        <div class="preset-info" data-action="load">
                            <div class="preset-name">${this.escapeHtml(preset.name)}</div>
                            <div class="preset-details">${preset.timerDuration}s Übung, ${preset.pauseDuration}s Pause, ${preset.repetitions}x</div>
                        </div>
                        <button class="btn-delete-preset" data-action="delete">✕</button>
                    </div>
                `).join('');
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            bindEvents() {
                document.getElementById('startStopBtn').addEventListener('click', () => {
                    if (this.isRunning) {
                        this.stop();
                    } else {
                        this.start();
                    }
                });

                document.getElementById('pauseResumeBtn').addEventListener('click', () => {
                    if (this.isPaused) {
                        this.resume();
                    } else {
                        this.pause();
                    }
                });

                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.reset();
                });

                document.getElementById('timerDuration').addEventListener('change', (e) => {
                    this.totalTime = parseInt(e.target.value);
                    if (!this.isRunning) {
                        this.currentTime = this.totalTime;
                        this.updateDisplay();
                    }
                    this.saveSettings();
                });

                document.getElementById('pauseDuration').addEventListener('change', (e) => {
                    this.pauseTime = parseInt(e.target.value);
                    this.saveSettings();
                });

                document.getElementById('repetitions').addEventListener('change', (e) => {
                    this.repetitions = parseInt(e.target.value);
                    this.updateDisplay();
                    this.saveSettings();
                });

                document.getElementById('soundSelect').addEventListener('change', (e) => {
                    this.selectedSound = e.target.value;
                    this.saveSettings();
                });

                document.getElementById('volume').addEventListener('input', (e) => {
                    this.volume = e.target.value / 100;
                    document.getElementById('volumeValue').textContent = e.target.value;
                    this.saveSettings();
                });

                // Settings modal events
                document.getElementById('settingsFab').addEventListener('click', () => {
                    this.openSettings();
                });

                document.getElementById('closeSettings').addEventListener('click', () => {
                    this.closeSettings();
                });

                document.getElementById('settingsModal').addEventListener('click', (e) => {
                    if (e.target.id === 'settingsModal') {
                        this.closeSettings();
                    }
                });

                // Close modal with Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && document.getElementById('settingsModal').classList.contains('active')) {
                        this.closeSettings();
                    }
                });

                // Preset events
                document.getElementById('savePresetBtn').addEventListener('click', () => {
                    this.savePreset();
                });

                document.getElementById('presetName').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.savePreset();
                    }
                });

                document.getElementById('presetsList').addEventListener('click', (e) => {
                    const presetItem = e.target.closest('.preset-item');
                    if (!presetItem) return;

                    const presetId = parseInt(presetItem.dataset.presetId);
                    const action = e.target.dataset.action || e.target.closest('[data-action]')?.dataset.action;

                    if (action === 'delete') {
                        this.deletePreset(presetId);
                    } else if (action === 'load') {
                        this.loadPreset(presetId);
                    }
                });

                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.isRunning && !this.isPaused) {
                        // Optional: Pause when app goes to background
                    }
                });
            }

            openSettings() {
                document.getElementById('settingsModal').classList.add('active');
            }

            closeSettings() {
                document.getElementById('settingsModal').classList.remove('active');
            }

            start() {
                if (this.currentRepetition === 0) {
                    this.currentRepetition = 1;
                    this.currentTime = this.totalTime;
                }

                this.isRunning = true;
                this.isPaused = false;

                this.intervalId = setInterval(() => this.tick(), 1000);
                this.updateDisplay();
            }

            stop() {
                this.isRunning = false;
                this.isPaused = false;
                clearInterval(this.intervalId);
                this.currentRepetition = 0;
                this.currentTime = this.totalTime;
                this.isInBreak = false;
                this.updateDisplay();
            }

            pause() {
                this.isPaused = true;
                clearInterval(this.intervalId);
                this.updateDisplay();
            }

            resume() {
                this.isPaused = false;
                this.intervalId = setInterval(() => this.tick(), 1000);
                this.updateDisplay();
            }

            reset() {
                this.stop();
            }

            tick() {
                this.currentTime--;

                // Countdown-Beeps in den letzten 3 Sekunden (Übung und Pause)
                if (this.currentTime > 0 && this.currentTime <= 3) {
                    this.playSound('countdown');
                }

                if (this.currentTime <= 0) {
                    if (this.isInBreak) {
                        // Ende der Pause - normaler Beep
                        this.playSound('main');
                        this.vibrate();

                        this.isInBreak = false;
                        this.currentRepetition++;

                        if (this.currentRepetition > this.repetitions) {
                            this.complete();
                            return;
                        }

                        this.currentTime = this.totalTime;
                    } else {
                        // Ende der Übung
                        if (this.currentRepetition < this.repetitions && this.pauseTime > 0) {
                            // Start der Pause - Klingeln
                            this.playSound('breakStart');
                            this.vibrate();
                            this.isInBreak = true;
                            this.currentTime = this.pauseTime;
                        } else {
                            // Keine Pause - direkt zur nächsten Übung
                            this.playSound('main');
                            this.vibrate();
                            this.currentRepetition++;

                            if (this.currentRepetition > this.repetitions) {
                                this.complete();
                                return;
                            }

                            this.currentTime = this.totalTime;
                        }
                    }
                }

                this.updateDisplay();
            }

            complete() {
                this.playSound('main');
                this.vibrate();
                this.stop();

                const timerStatus = document.getElementById('timerStatus');
                timerStatus.textContent = 'Fertig! Gut gemacht!';
                timerStatus.style.color = 'var(--accent)';

                setTimeout(() => {
                    timerStatus.textContent = '';
                    timerStatus.style.color = '';
                }, 3000);
            }

            updateDisplay() {
                const startStopBtn = document.getElementById('startStopBtn');
                const pauseResumeBtn = document.getElementById('pauseResumeBtn');
                const countdown = document.getElementById('countdown');
                const timerStatus = document.getElementById('timerStatus');
                const repetitionCounter = document.getElementById('repetitionCounter');

                const minutes = Math.floor(this.currentTime / 60);
                const seconds = this.currentTime % 60;
                countdown.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                countdown.classList.remove('paused', 'in-break', 'pulse');
                timerStatus.classList.remove('in-break');

                if (this.isRunning) {
                    startStopBtn.textContent = 'Stop';
                    startStopBtn.classList.add('running');
                    pauseResumeBtn.disabled = false;

                    if (this.isPaused) {
                        countdown.classList.add('paused');
                        timerStatus.textContent = 'Pausiert';
                        pauseResumeBtn.textContent = 'Fortsetzen';
                    } else if (this.isInBreak) {
                        countdown.classList.add('in-break');
                        timerStatus.textContent = 'Pause';
                        timerStatus.classList.add('in-break');
                        pauseResumeBtn.textContent = 'Pause';
                    } else {
                        timerStatus.textContent = 'Übung';
                        pauseResumeBtn.textContent = 'Pause';

                        if (this.currentTime <= 3 && this.currentTime > 0) {
                            countdown.classList.add('pulse');
                        }
                    }
                } else {
                    startStopBtn.textContent = 'Start';
                    startStopBtn.classList.remove('running');
                    pauseResumeBtn.disabled = true;
                    pauseResumeBtn.textContent = 'Pause';
                    timerStatus.textContent = '';
                }

                repetitionCounter.textContent = `Übung ${this.currentRepetition} / ${this.repetitions}`;

                // Update circular progress ring
                const circleProgress = document.getElementById('circleProgress');
                const radius = 140;
                const circumference = 2 * Math.PI * radius;

                circleProgress.style.strokeDasharray = `${circumference} ${circumference}`;

                // Calculate progress (remaining time shown as emptying circle)
                const currentMaxTime = this.isInBreak ? this.pauseTime : this.totalTime;
                const progressPercent = this.isRunning ?
                    (this.currentTime / currentMaxTime) : 1;
                const offset = circumference * (1 - progressPercent);

                circleProgress.style.strokeDashoffset = offset;

                // Update circle color classes
                circleProgress.classList.remove('in-break', 'paused');
                if (this.isPaused) {
                    circleProgress.classList.add('paused');
                } else if (this.isInBreak) {
                    circleProgress.classList.add('in-break');
                }
            }
        }

        let timerManager;

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            timerManager = new TimerManager();
        });
    </script>
</body>
</html>
