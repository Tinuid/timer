<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ff6b35">
    <meta name="description" content="Timer für Dehnübungen mit Wiederholungen">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="assets/icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="assets/icons/icon-512.png">
    <link rel="manifest" href="manifest.json">
    <title>Dehnübungen Timer</title>

    <style>
        :root {
            --primary: #ff6b35;
            --primary-dark: #e55a25;
            --accent: #ffa07a;
            --accent-dark: #ff8c5a;
            --bg: #0a0a0a;
            --bg-card: #1a1a1a;
            --text: #ffffff;
            --text-light: #a0a0a0;
            --border: #2a2a2a;
            --ring-bg: #2a2a2a;
            --danger: #ef4444;
            --warning: #f59e0b;

            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;

            --radius: 12px;
            --radius-lg: 16px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
            touch-action: manipulation;
            margin: 0;
            padding: 0;
        }

        main {
            flex: 1;
            padding: var(--spacing-md) var(--spacing-sm);
            width: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .settings-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            box-shadow: var(--shadow);
            z-index: 100;
            font-size: 24px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .settings-fab:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .settings-fab:active {
            transform: scale(0.95);
        }

        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-md);
        }

        .settings-modal.active {
            display: flex;
        }

        .settings-content {
            background: var(--bg-card);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
        }

        .close-btn {
            background: transparent;
            border: none;
            color: var(--text-light);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
            min-height: auto;
        }

        .close-btn:hover {
            background: var(--border);
            color: var(--text);
        }

        .setting-group {
            margin-bottom: var(--spacing-md);
        }

        .setting-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-light);
            margin-bottom: var(--spacing-xs);
        }

        input[type="number"],
        select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            background: #1a1a1a;
            color: var(--text);
            transition: border-color 0.2s ease;
        }

        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
        }

        option {
            background: #1a1a1a;
            color: var(--text);
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: var(--primary-dark);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
        }

        .volume-display {
            text-align: right;
            font-size: 0.875rem;
            color: var(--text-light);
            margin-top: var(--spacing-xs);
        }

        .sound-sections {
            border-top: 1px solid var(--border);
            padding-top: var(--spacing-md);
        }

        .sound-section {
            margin-bottom: var(--spacing-sm);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .sound-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg);
            cursor: pointer;
            user-select: none;
            font-weight: 500;
            font-size: 0.95rem;
            color: var(--text);
        }

        .sound-section-header:hover {
            background: var(--border);
        }

        .sound-section-header .arrow {
            transition: transform 0.2s ease;
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .sound-section.open .sound-section-header .arrow {
            transform: rotate(90deg);
        }

        .sound-section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 1rem;
        }

        .sound-section.open .sound-section-content {
            max-height: 200px;
            padding: 0.75rem 1rem;
        }

        .sound-row {
            display: flex;
            gap: var(--spacing-xs);
            align-items: center;
        }

        .sound-row select {
            flex: 1;
        }

        .btn-test {
            padding: 0.75rem;
            min-height: auto;
            min-width: 44px;
            background: var(--border);
            color: var(--text);
            border: 1px solid var(--border);
            font-size: 1rem;
            cursor: pointer;
            border-radius: var(--radius);
        }

        .btn-test:hover {
            background: #333;
        }

        .toggle-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--border);
        }

        .toggle-group label {
            margin-bottom: 0;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            border-radius: 28px;
            transition: 0.3s;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(22px);
        }

        .timer-display {
            text-align: center;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-md);
        }

        .circular-timer {
            position: relative;
            width: min(90vw, 90vh);
            height: min(90vw, 90vh);
            max-width: 500px;
            max-height: 500px;
        }

        .timer-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .circular-timer svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .circle-bg {
            fill: none;
            stroke: var(--ring-bg);
            stroke-width: 12;
        }

        .circle-progress {
            fill: none;
            stroke: var(--primary);
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke 0.3s ease;
        }

        .circle-progress.in-break {
            stroke: var(--accent);
        }

        .circle-progress.paused {
            stroke: var(--warning);
        }

        .countdown {
            font-size: clamp(3rem, 12vw, 6rem);
            font-weight: 700;
            color: var(--text);
            font-variant-numeric: tabular-nums;
            line-height: 1;
        }

        .countdown.paused {
            color: var(--warning);
        }

        .countdown.in-break {
            color: var(--accent);
        }

        .timer-status {
            font-size: 1.2rem;
            margin-top: 0.5rem;
            color: var(--text-light);
        }

        .timer-status.in-break {
            color: var(--accent);
        }

        .repetition-counter {
            font-size: 1.5rem;
            color: var(--text);
            text-align: center;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            width: 100%;
            max-width: 400px;
        }

        button {
            padding: 1rem;
            border: none;
            border-radius: var(--radius);
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 56px;
            touch-action: manipulation;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 12px 20px rgba(255, 107, 53, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary.running {
            background: var(--danger);
        }

        .btn-primary.running:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #2a2a2a;
            color: var(--text);
            border: 1px solid #3a3a3a;
        }

        .btn-secondary:hover {
            background: #333333;
        }

        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary:disabled:hover {
            background: #2a2a2a;
            transform: none;
        }

        .secondary-controls {
            display: flex;
            gap: var(--spacing-sm);
        }

        .secondary-controls button {
            flex: 1;
        }

        .hidden {
            display: none;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .countdown.pulse {
            animation: pulse 1s ease-in-out infinite;
        }

        @media (max-width: 360px) {
            .settings-fab {
                bottom: 15px;
                right: 15px;
                width: 48px;
                height: 48px;
                font-size: 20px;
            }
        }

        .preset-controls {
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-lg);
            border-bottom: 1px solid var(--border);
        }

        .preset-actions {
            display: flex;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-xs);
        }

        .preset-actions button {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.875rem;
            min-height: 40px;
        }

        .btn-preset {
            background: var(--border);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-preset:hover:not(:disabled) {
            background: #333333;
        }

        .btn-preset.primary {
            background: var(--primary);
            color: white;
        }

        .btn-preset.primary:hover {
            background: var(--primary-dark);
        }

        .btn-preset.danger {
            background: var(--danger);
            color: white;
        }

        .btn-preset.danger:hover {
            background: #dc2626;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }
    </style>
</head>
<body>
    <main>
        <div class="repetition-counter" id="repetitionCounter">Übung 0 / 10</div>

        <div class="timer-display">
            <div class="circular-timer">
                <svg viewBox="0 0 300 300">
                    <circle class="circle-bg" cx="150" cy="150" r="140"></circle>
                    <circle class="circle-progress" id="circleProgress" cx="150" cy="150" r="140"></circle>
                </svg>
                <div class="timer-center">
                    <div class="countdown" id="countdown">01:00</div>
                    <div class="timer-status" id="timerStatus"></div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn-primary" id="startStopBtn">Start</button>
            <div class="secondary-controls">
                <button class="btn-secondary" id="pauseResumeBtn" disabled>Pause</button>
                <button class="btn-secondary" id="resetBtn">Reset</button>
            </div>
        </div>
    </main>

    <button class="settings-fab" id="settingsFab">⚙</button>

    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="modal-header">
                <h2>Einstellungen</h2>
                <button class="close-btn" id="closeSettings">✕</button>
            </div>

            <div class="preset-controls">
                <div class="setting-group">
                    <label for="presetSelect">Preset</label>
                    <select id="presetSelect">
                        <option value="">-- Neues Preset --</option>
                    </select>
                </div>
                <div class="preset-actions">
                    <button class="btn-preset primary" id="savePresetBtn">Speichern</button>
                    <button class="btn-preset" id="renamePresetBtn" disabled>Umbenennen</button>
                    <button class="btn-preset danger" id="deletePresetBtn" disabled>Löschen</button>
                </div>
            </div>

            <div class="settings-inputs">
                <div class="setting-group">
                    <label for="timerDuration">Timer-Dauer (Sekunden)</label>
                    <input type="number" id="timerDuration" min="10" max="600" step="5" value="60">
                </div>

                <div class="setting-group">
                    <label for="prepDuration">Vorbereitungszeit (Sekunden)</label>
                    <input type="number" id="prepDuration" min="0" max="30" step="1" value="5">
                </div>

                <div class="setting-group">
                    <label for="pauseDuration">Pause zwischen Übungen (Sekunden)</label>
                    <input type="number" id="pauseDuration" min="0" max="60" step="5" value="5">
                </div>

                <div class="setting-group">
                    <label for="repetitions">Anzahl Wiederholungen</label>
                    <input type="number" id="repetitions" min="1" max="50" value="10">
                </div>

                <div class="sound-sections">
                    <div class="sound-section" id="countdownSection">
                        <div class="sound-section-header" data-section="countdownSection">
                            <span>Countdown (letzte 3 Sek.)</span>
                            <span class="arrow">▸</span>
                        </div>
                        <div class="sound-section-content">
                            <div class="setting-group">
                                <label for="countdownSound">Ton</label>
                                <div class="sound-row">
                                    <select id="countdownSound">
                                        <option value="beep">Beep</option>
                                        <option value="chime">Chime</option>
                                        <option value="bell">Glocke</option>
                                        <option value="whistle">Pfiff</option>
                                        <option value="gong">Gong</option>
                                        <option value="doubleBeep">Doppel-Beep</option>
                                        <option value="tripleRing">Dreifach-Klingeln</option>
                                        <option value="softPing">Sanfter Ping</option>
                                        <option value="alarm">Alarm</option>
                                        <option value="trumpet">Trompete</option>
                                        <option value="harp">Harfe</option>
                                        <option value="click" selected>Klick</option>
                                    </select>
                                    <button class="btn-test" id="testCountdownSound" title="Ton testen">&#9654;</button>
                                </div>
                            </div>
                            <div class="setting-group">
                                <label for="countdownVolume">Lautstärke</label>
                                <input type="range" id="countdownVolume" min="0" max="100" value="30">
                                <div class="volume-display"><span id="countdownVolumeValue">30</span>%</div>
                            </div>
                        </div>
                    </div>

                    <div class="sound-section" id="pauseSection">
                        <div class="sound-section-header" data-section="pauseSection">
                            <span>Pause</span>
                            <span class="arrow">▸</span>
                        </div>
                        <div class="sound-section-content">
                            <div class="setting-group">
                                <label for="pauseSound">Ton</label>
                                <div class="sound-row">
                                    <select id="pauseSound">
                                        <option value="beep">Beep</option>
                                        <option value="chime">Chime</option>
                                        <option value="bell">Glocke</option>
                                        <option value="whistle">Pfiff</option>
                                        <option value="gong">Gong</option>
                                        <option value="doubleBeep">Doppel-Beep</option>
                                        <option value="tripleRing" selected>Dreifach-Klingeln</option>
                                        <option value="softPing">Sanfter Ping</option>
                                        <option value="alarm">Alarm</option>
                                        <option value="trumpet">Trompete</option>
                                        <option value="harp">Harfe</option>
                                        <option value="click">Klick</option>
                                    </select>
                                    <button class="btn-test" id="testPauseSound" title="Ton testen">&#9654;</button>
                                </div>
                            </div>
                            <div class="setting-group">
                                <label for="pauseVolume">Lautstärke</label>
                                <input type="range" id="pauseVolume" min="0" max="100" value="70">
                                <div class="volume-display"><span id="pauseVolumeValue">70</span>%</div>
                            </div>
                        </div>
                    </div>

                    <div class="sound-section" id="exerciseSection">
                        <div class="sound-section-header" data-section="exerciseSection">
                            <span>Übung</span>
                            <span class="arrow">▸</span>
                        </div>
                        <div class="sound-section-content">
                            <div class="setting-group">
                                <label for="exerciseSound">Ton</label>
                                <div class="sound-row">
                                    <select id="exerciseSound">
                                        <option value="beep" selected>Beep</option>
                                        <option value="chime">Chime</option>
                                        <option value="bell">Glocke</option>
                                        <option value="whistle">Pfiff</option>
                                        <option value="gong">Gong</option>
                                        <option value="doubleBeep">Doppel-Beep</option>
                                        <option value="tripleRing">Dreifach-Klingeln</option>
                                        <option value="softPing">Sanfter Ping</option>
                                        <option value="alarm">Alarm</option>
                                        <option value="trumpet">Trompete</option>
                                        <option value="harp">Harfe</option>
                                        <option value="click">Klick</option>
                                    </select>
                                    <button class="btn-test" id="testExerciseSound" title="Ton testen">&#9654;</button>
                                </div>
                            </div>
                            <div class="setting-group">
                                <label for="exerciseVolume">Lautstärke</label>
                                <input type="range" id="exerciseVolume" min="0" max="100" value="80">
                                <div class="volume-display"><span id="exerciseVolumeValue">80</span>%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="toggle-group">
                    <label for="wakeLockToggle">Bildschirm aktiv halten</label>
                    <div class="toggle-switch">
                        <input type="checkbox" id="wakeLockToggle">
                        <span class="toggle-slider"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class TimerManager {
            constructor() {
                this.currentTime = 0;
                this.totalTime = 60;
                this.pauseTime = 5;
                this.prepTime = 5;
                this.repetitions = 10;
                this.currentRepetition = 0;
                this.isRunning = false;
                this.isPaused = false;
                this.isInBreak = false;
                this.isInPrep = false;
                this.intervalId = null;
                this.animationFrameId = null;
                this.lastTickTime = 0;
                this.phaseEndTime = 0;
                this.timerWorker = null;
                this.countdownSound = 'click';
                this.countdownVolume = 0.3;
                this.pauseSound = 'tripleRing';
                this.pauseVolume = 0.7;
                this.exerciseSound = 'beep';
                this.exerciseVolume = 0.8;
                this.keepScreenActive = false;
                this.wakeLockSentinel = null;

                this.audioContext = null;
                this.sounds = {};
                this.notificationPermission = Notification?.permission || 'denied';
                this.pendingPhaseSound = null;

                this.presets = [];
                this.currentPresetId = null;

                this.circleCircumference = 2 * Math.PI * 140;

                this.initWorker();
                this.initAudio();
                this.loadSettings();
                this.loadPresets();
                this.bindEvents();
                this.updateDisplay();
                this.updatePresetUI();
            }

            initWorker() {
                try {
                    const workerCode = `
                        let intervalId = null;
                        self.onmessage = function(e) {
                            if (e.data === 'start') {
                                if (intervalId) clearInterval(intervalId);
                                intervalId = setInterval(() => self.postMessage('tick'), 250);
                            } else if (e.data === 'stop') {
                                if (intervalId) clearInterval(intervalId);
                                intervalId = null;
                            }
                        };
                    `;
                    const blob = new Blob([workerCode], { type: 'application/javascript' });
                    this.timerWorker = new Worker(URL.createObjectURL(blob));
                    this.timerWorker.onmessage = () => {
                        if (this.isRunning && !this.isPaused) {
                            this.tick();
                        }
                    };
                } catch (e) {
                    console.warn('Web Worker not available, falling back to setInterval');
                    this.timerWorker = null;
                }
            }

            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.audioUnlocked = false;

                    // iOS/Safari erfordert Audio-Entsperrung bei Benutzerinteraktion
                    const unlockAudio = async () => {
                        if (this.audioUnlocked) return;

                        try {
                            // AudioContext fortsetzen falls suspended
                            if (this.audioContext.state === 'suspended') {
                                await this.audioContext.resume();
                            }

                            // Kurzen stillen Ton abspielen um iOS zu entsperren
                            const buffer = this.audioContext.createBuffer(1, 1, 22050);
                            const source = this.audioContext.createBufferSource();
                            source.buffer = buffer;
                            source.connect(this.audioContext.destination);
                            source.start(0);

                            this.audioUnlocked = true;
                            console.log('Audio unlocked for iOS');

                            // Event-Listener nach erfolgreichem Entsperren entfernen
                            document.removeEventListener('touchstart', unlockAudio, true);
                            document.removeEventListener('touchend', unlockAudio, true);
                            document.removeEventListener('click', unlockAudio, true);
                        } catch (e) {
                            console.warn('Could not unlock audio:', e);
                        }
                    };

                    // Event-Listener für erste Benutzerinteraktion hinzufügen
                    document.addEventListener('touchstart', unlockAudio, true);
                    document.addEventListener('touchend', unlockAudio, true);
                    document.addEventListener('click', unlockAudio, true);

                } catch (e) {
                    console.warn('Web Audio API not supported');
                }
            }

            async playSound(phase) {
                if (!this.audioContext) return;
                try {
                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }

                    const phaseSettings = {
                        countdown: { sound: this.countdownSound, volume: this.countdownVolume },
                        pause: { sound: this.pauseSound, volume: this.pauseVolume },
                        exercise: { sound: this.exerciseSound, volume: this.exerciseVolume }
                    };

                    const settings = phaseSettings[phase];
                    if (!settings) return;

                    const isCountdown = phase === 'countdown';
                    this.synthesizeSound(settings.sound, settings.volume, isCountdown);
                } catch (e) {
                    console.warn('Could not play sound:', e);
                }
            }

            playTestSound(phase) {
                const phaseSettings = {
                    countdown: { sound: this.countdownSound, volume: this.countdownVolume },
                    pause: { sound: this.pauseSound, volume: this.pauseVolume },
                    exercise: { sound: this.exerciseSound, volume: this.exerciseVolume }
                };
                const settings = phaseSettings[phase];
                if (!settings) return;
                this.playSound(phase);
            }

            synthesizeSound(soundName, volume, short = false) {
                const ctx = this.audioContext;
                const now = ctx.currentTime;

                if (short) {
                    // Countdown-Tick: kurze Version des gewählten Tons
                    const freqMap = {
                        beep: 800, chime: 1200, bell: 600, whistle: 1500,
                        gong: 200, doubleBeep: 800, tripleRing: 1000,
                        softPing: 440, alarm: 800, trumpet: 523, harp: 880, click: 1000
                    };
                    this.playTone(freqMap[soundName] || 600, 'sine', 0.1, volume * 0.5);
                    return;
                }

                switch (soundName) {
                    case 'beep':
                        this.playTone(800, 'square', 0.5, volume);
                        break;
                    case 'chime':
                        this.playTone(1200, 'square', 0.5, volume);
                        break;
                    case 'bell':
                        this.playTone(600, 'sine', 0.8, volume);
                        break;
                    case 'whistle': {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(1500, now);
                        osc.frequency.exponentialRampToValueAtTime(800, now + 0.6);
                        gain.gain.setValueAtTime(volume, now);
                        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
                        osc.start(now);
                        osc.stop(now + 0.6);
                        break;
                    }
                    case 'gong':
                        this.playTone(200, 'sine', 1.5, volume);
                        break;
                    case 'doubleBeep':
                        this.playTone(800, 'square', 0.1, volume, 0);
                        this.playTone(800, 'square', 0.1, volume, 0.2);
                        break;
                    case 'tripleRing':
                        for (let i = 0; i < 3; i++) {
                            this.playTone(1000, 'sine', 0.2, volume * 0.7, i * 0.25);
                        }
                        break;
                    case 'softPing':
                        this.playTone(440, 'sine', 0.3, volume);
                        break;
                    case 'alarm':
                        this.playTone(800, 'square', 0.25, volume, 0);
                        this.playTone(600, 'square', 0.25, volume, 0.3);
                        break;
                    case 'trumpet':
                        this.playTone(523, 'sawtooth', 0.6, volume);
                        break;
                    case 'harp': {
                        const notes = [523, 440, 349, 262];
                        notes.forEach((freq, i) => {
                            this.playTone(freq, 'sine', 0.4, volume * 0.8, i * 0.12);
                        });
                        break;
                    }
                    case 'click':
                        this.playTone(1000, 'square', 0.05, volume);
                        break;
                    default:
                        this.playTone(800, 'square', 0.5, volume);
                }
            }

            playTone(freq, type, duration, volume, delay = 0) {
                const ctx = this.audioContext;
                const now = ctx.currentTime + delay;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = freq;
                osc.type = type;
                gain.gain.setValueAtTime(Math.max(volume, 0.001), now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
                osc.start(now);
                osc.stop(now + duration + 0.01);
            }

            vibrate() {
                if ('vibrate' in navigator) {
                    navigator.vibrate([200, 100, 200]);
                }
            }

            loadSettings() {
                try {
                    const settings = JSON.parse(localStorage.getItem('timerSettings') || '{}');

                    this.totalTime = settings.timerDuration || 60;
                    this.pauseTime = settings.pauseDuration || 5;
                    this.prepTime = settings.prepDuration !== undefined ? settings.prepDuration : 5;
                    this.repetitions = settings.repetitions || 10;

                    // Per-phase sound settings (with backward compatibility)
                    if (settings.countdownSound) {
                        this.countdownSound = settings.countdownSound;
                        this.countdownVolume = settings.countdownVolume !== undefined ? settings.countdownVolume : 0.3;
                        this.pauseSound = settings.pauseSound || 'tripleRing';
                        this.pauseVolume = settings.pauseVolume !== undefined ? settings.pauseVolume : 0.7;
                        this.exerciseSound = settings.exerciseSound || 'beep';
                        this.exerciseVolume = settings.exerciseVolume !== undefined ? settings.exerciseVolume : 0.8;
                    } else if (settings.selectedSound) {
                        // Migration from old single sound setting
                        this.countdownSound = 'click';
                        this.countdownVolume = 0.3;
                        this.pauseSound = 'tripleRing';
                        this.pauseVolume = settings.volume !== undefined ? settings.volume * 0.7 : 0.7;
                        this.exerciseSound = settings.selectedSound;
                        this.exerciseVolume = settings.volume !== undefined ? settings.volume : 0.8;
                    }

                    this.keepScreenActive = settings.keepScreenActive || false;

                    document.getElementById('timerDuration').value = this.totalTime;
                    document.getElementById('prepDuration').value = this.prepTime;
                    document.getElementById('pauseDuration').value = this.pauseTime;
                    document.getElementById('repetitions').value = this.repetitions;

                    document.getElementById('countdownSound').value = this.countdownSound;
                    document.getElementById('countdownVolume').value = this.countdownVolume * 100;
                    document.getElementById('countdownVolumeValue').textContent = Math.round(this.countdownVolume * 100);

                    document.getElementById('pauseSound').value = this.pauseSound;
                    document.getElementById('pauseVolume').value = this.pauseVolume * 100;
                    document.getElementById('pauseVolumeValue').textContent = Math.round(this.pauseVolume * 100);

                    document.getElementById('exerciseSound').value = this.exerciseSound;
                    document.getElementById('exerciseVolume').value = this.exerciseVolume * 100;
                    document.getElementById('exerciseVolumeValue').textContent = Math.round(this.exerciseVolume * 100);

                    document.getElementById('wakeLockToggle').checked = this.keepScreenActive;

                    this.currentTime = this.totalTime;
                } catch (e) {
                    console.warn('Could not load settings:', e);
                }
            }

            saveSettings() {
                const settings = {
                    timerDuration: this.totalTime,
                    pauseDuration: this.pauseTime,
                    prepDuration: this.prepTime,
                    repetitions: this.repetitions,
                    countdownSound: this.countdownSound,
                    countdownVolume: this.countdownVolume,
                    pauseSound: this.pauseSound,
                    pauseVolume: this.pauseVolume,
                    exerciseSound: this.exerciseSound,
                    exerciseVolume: this.exerciseVolume,
                    keepScreenActive: this.keepScreenActive
                };

                try {
                    localStorage.setItem('timerSettings', JSON.stringify(settings));
                } catch (e) {
                    console.warn('Could not save settings:', e);
                }
            }

            loadPresets() {
                try {
                    const presetsData = localStorage.getItem('timerPresets');
                    this.presets = presetsData ? JSON.parse(presetsData) : [];

                    const currentPresetId = localStorage.getItem('currentPresetId');
                    this.currentPresetId = currentPresetId || null;
                } catch (e) {
                    console.warn('Could not load presets:', e);
                    this.presets = [];
                    this.currentPresetId = null;
                }
            }

            savePresetsToStorage() {
                try {
                    localStorage.setItem('timerPresets', JSON.stringify(this.presets));
                    if (this.currentPresetId) {
                        localStorage.setItem('currentPresetId', this.currentPresetId);
                    } else {
                        localStorage.removeItem('currentPresetId');
                    }
                } catch (e) {
                    console.warn('Could not save presets:', e);
                }
            }

            generatePresetId() {
                return 'preset_' + Date.now() + '_' + Math.random().toString(36).substring(2, 11);
            }

            createPreset(name) {
                const preset = {
                    id: this.generatePresetId(),
                    name: name,
                    timerDuration: this.totalTime,
                    pauseDuration: this.pauseTime,
                    prepDuration: this.prepTime,
                    repetitions: this.repetitions,
                    countdownSound: this.countdownSound,
                    countdownVolume: this.countdownVolume,
                    pauseSound: this.pauseSound,
                    pauseVolume: this.pauseVolume,
                    exerciseSound: this.exerciseSound,
                    exerciseVolume: this.exerciseVolume
                };

                this.presets.push(preset);
                this.currentPresetId = preset.id;
                this.savePresetsToStorage();
                this.updatePresetUI();

                return preset;
            }

            loadPreset(id) {
                const preset = this.presets.find(p => p.id === id);
                if (!preset) return;

                this.totalTime = preset.timerDuration;
                this.pauseTime = preset.pauseDuration;
                this.prepTime = preset.prepDuration !== undefined ? preset.prepDuration : 5;
                this.repetitions = preset.repetitions;

                // Load per-phase sound settings (with backward compatibility)
                if (preset.countdownSound) {
                    this.countdownSound = preset.countdownSound;
                    this.countdownVolume = preset.countdownVolume !== undefined ? preset.countdownVolume : 0.3;
                    this.pauseSound = preset.pauseSound || 'tripleRing';
                    this.pauseVolume = preset.pauseVolume !== undefined ? preset.pauseVolume : 0.7;
                    this.exerciseSound = preset.exerciseSound || 'beep';
                    this.exerciseVolume = preset.exerciseVolume !== undefined ? preset.exerciseVolume : 0.8;
                } else if (preset.selectedSound) {
                    this.countdownSound = 'click';
                    this.countdownVolume = 0.3;
                    this.pauseSound = 'tripleRing';
                    this.pauseVolume = preset.volume !== undefined ? preset.volume * 0.7 : 0.7;
                    this.exerciseSound = preset.selectedSound;
                    this.exerciseVolume = preset.volume !== undefined ? preset.volume : 0.8;
                }

                document.getElementById('timerDuration').value = this.totalTime;
                document.getElementById('prepDuration').value = this.prepTime;
                document.getElementById('pauseDuration').value = this.pauseTime;
                document.getElementById('repetitions').value = this.repetitions;

                document.getElementById('countdownSound').value = this.countdownSound;
                document.getElementById('countdownVolume').value = this.countdownVolume * 100;
                document.getElementById('countdownVolumeValue').textContent = Math.round(this.countdownVolume * 100);

                document.getElementById('pauseSound').value = this.pauseSound;
                document.getElementById('pauseVolume').value = this.pauseVolume * 100;
                document.getElementById('pauseVolumeValue').textContent = Math.round(this.pauseVolume * 100);

                document.getElementById('exerciseSound').value = this.exerciseSound;
                document.getElementById('exerciseVolume').value = this.exerciseVolume * 100;
                document.getElementById('exerciseVolumeValue').textContent = Math.round(this.exerciseVolume * 100);

                if (!this.isRunning) {
                    this.currentTime = this.totalTime;
                    this.updateDisplay();
                }

                this.currentPresetId = id;
                localStorage.setItem('currentPresetId', id);
                this.updatePresetUI();
            }

            updatePreset(id) {
                const preset = this.presets.find(p => p.id === id);
                if (!preset) return;

                preset.timerDuration = this.totalTime;
                preset.pauseDuration = this.pauseTime;
                preset.prepDuration = this.prepTime;
                preset.repetitions = this.repetitions;
                preset.countdownSound = this.countdownSound;
                preset.countdownVolume = this.countdownVolume;
                preset.pauseSound = this.pauseSound;
                preset.pauseVolume = this.pauseVolume;
                preset.exerciseSound = this.exerciseSound;
                preset.exerciseVolume = this.exerciseVolume;
                // Remove old fields
                delete preset.selectedSound;
                delete preset.volume;

                this.savePresetsToStorage();
                this.updatePresetUI();
            }

            renamePreset(id, newName) {
                const preset = this.presets.find(p => p.id === id);
                if (!preset) return;

                preset.name = newName;
                this.savePresetsToStorage();
                this.updatePresetUI();
            }

            deletePreset(id) {
                this.presets = this.presets.filter(p => p.id !== id);

                if (this.currentPresetId === id) {
                    this.currentPresetId = null;
                    localStorage.removeItem('currentPresetId');
                }

                this.savePresetsToStorage();
                this.updatePresetUI();
            }

            updatePresetUI() {
                const presetSelect = document.getElementById('presetSelect');
                const renameBtn = document.getElementById('renamePresetBtn');
                const deleteBtn = document.getElementById('deletePresetBtn');

                // Dropdown aktualisieren
                presetSelect.innerHTML = '<option value="">-- Neues Preset --</option>';

                this.presets.forEach(preset => {
                    const option = document.createElement('option');
                    option.value = preset.id;
                    option.textContent = preset.name;
                    presetSelect.appendChild(option);
                });

                // Aktuelles Preset auswählen
                if (this.currentPresetId) {
                    presetSelect.value = this.currentPresetId;
                }

                // Buttons aktivieren/deaktivieren
                const hasPreset = this.currentPresetId !== null;
                renameBtn.disabled = !hasPreset;
                deleteBtn.disabled = !hasPreset;
            }

            bindEvents() {
                document.getElementById('startStopBtn').addEventListener('click', () => {
                    if (this.isRunning) {
                        this.stop();
                    } else {
                        this.start();
                    }
                });

                document.getElementById('pauseResumeBtn').addEventListener('click', () => {
                    if (this.isPaused) {
                        this.resume();
                    } else {
                        this.pause();
                    }
                });

                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.reset();
                });

                document.getElementById('timerDuration').addEventListener('change', (e) => {
                    this.totalTime = parseInt(e.target.value);
                    if (!this.isRunning) {
                        this.currentTime = this.totalTime;
                        this.updateDisplay();
                    }
                    this.saveSettings();
                });

                document.getElementById('prepDuration').addEventListener('change', (e) => {
                    this.prepTime = parseInt(e.target.value);
                    this.saveSettings();
                });

                document.getElementById('pauseDuration').addEventListener('change', (e) => {
                    this.pauseTime = parseInt(e.target.value);
                    this.saveSettings();
                });

                document.getElementById('repetitions').addEventListener('change', (e) => {
                    this.repetitions = parseInt(e.target.value);
                    this.updateDisplay();
                    this.saveSettings();
                });

                // Per-phase sound settings
                ['countdown', 'pause', 'exercise'].forEach(phase => {
                    document.getElementById(`${phase}Sound`).addEventListener('change', (e) => {
                        this[`${phase}Sound`] = e.target.value;
                        this.saveSettings();
                    });

                    document.getElementById(`${phase}Volume`).addEventListener('input', (e) => {
                        this[`${phase}Volume`] = e.target.value / 100;
                        document.getElementById(`${phase}VolumeValue`).textContent = e.target.value;
                        this.saveSettings();
                    });

                    document.getElementById(`test${phase.charAt(0).toUpperCase() + phase.slice(1)}Sound`).addEventListener('click', () => {
                        this.playSound(phase);
                    });
                });

                // Sound section collapsible headers
                document.querySelectorAll('.sound-section-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const sectionId = header.dataset.section;
                        document.getElementById(sectionId).classList.toggle('open');
                    });
                });

                // Wake lock toggle
                document.getElementById('wakeLockToggle').addEventListener('change', (e) => {
                    this.keepScreenActive = e.target.checked;
                    this.saveSettings();
                    if (this.keepScreenActive && this.isRunning) {
                        this.requestWakeLock();
                    } else if (!this.keepScreenActive) {
                        this.releaseWakeLock();
                    }
                });

                // Settings modal events
                document.getElementById('settingsFab').addEventListener('click', () => {
                    this.openSettings();
                });

                document.getElementById('closeSettings').addEventListener('click', () => {
                    this.closeSettings();
                });

                document.getElementById('settingsModal').addEventListener('click', (e) => {
                    if (e.target.id === 'settingsModal') {
                        this.closeSettings();
                    }
                });

                // Close modal with Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && document.getElementById('settingsModal').classList.contains('active')) {
                        this.closeSettings();
                    }
                });

                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden && this.isRunning) {
                        // Ausstehenden Phasenwechsel-Sound abspielen
                        if (this.pendingPhaseSound) {
                            this.playSound(this.pendingPhaseSound);
                            this.pendingPhaseSound = null;
                        }
                        if (!this.isPaused) {
                            // Timer sofort synchronisieren wenn Tab wieder sichtbar wird
                            this.tick();
                        }
                        if (this.keepScreenActive) {
                            this.requestWakeLock();
                        }
                    }
                });

                // Preset events
                document.getElementById('presetSelect').addEventListener('change', (e) => {
                    if (this.isRunning) {
                        alert('Bitte stoppen Sie den Timer, bevor Sie ein Preset laden.');
                        e.target.value = this.currentPresetId || '';
                        return;
                    }

                    const presetId = e.target.value;
                    if (presetId) {
                        this.loadPreset(presetId);
                    } else {
                        this.currentPresetId = null;
                        localStorage.removeItem('currentPresetId');
                        this.updatePresetUI();
                    }
                });

                document.getElementById('savePresetBtn').addEventListener('click', () => {
                    if (this.currentPresetId) {
                        // Update existing preset
                        const confirmUpdate = confirm('Möchten Sie das aktuelle Preset aktualisieren?');
                        if (confirmUpdate) {
                            this.updatePreset(this.currentPresetId);
                            alert('Preset aktualisiert!');
                        }
                    } else {
                        // Create new preset
                        const name = prompt('Bitte geben Sie einen Namen für das Preset ein:');
                        if (name && name.trim()) {
                            this.createPreset(name.trim());
                            alert('Preset gespeichert!');
                        }
                    }
                });

                document.getElementById('renamePresetBtn').addEventListener('click', () => {
                    if (!this.currentPresetId) return;

                    const currentPreset = this.presets.find(p => p.id === this.currentPresetId);
                    if (!currentPreset) return;

                    const newName = prompt('Neuer Name für das Preset:', currentPreset.name);
                    if (newName && newName.trim()) {
                        this.renamePreset(this.currentPresetId, newName.trim());
                        alert('Preset umbenannt!');
                    }
                });

                document.getElementById('deletePresetBtn').addEventListener('click', () => {
                    if (!this.currentPresetId) return;

                    const currentPreset = this.presets.find(p => p.id === this.currentPresetId);
                    if (!currentPreset) return;

                    const confirmDelete = confirm(`Möchten Sie das Preset "${currentPreset.name}" wirklich löschen?`);
                    if (confirmDelete) {
                        this.deletePreset(this.currentPresetId);
                        alert('Preset gelöscht!');
                    }
                });
            }

            openSettings() {
                document.getElementById('settingsModal').classList.add('active');
            }

            closeSettings() {
                document.getElementById('settingsModal').classList.remove('active');
            }

            startTickInterval() {
                if (this.timerWorker) {
                    this.timerWorker.postMessage('start');
                }
                // Keep setInterval as fallback (Worker handles background ticking)
                this.intervalId = setInterval(() => this.tick(), 1000);
            }

            stopTickInterval() {
                if (this.timerWorker) {
                    this.timerWorker.postMessage('stop');
                }
                clearInterval(this.intervalId);
            }

            start() {
                if (this.currentRepetition === 0) {
                    // Bei neuem Start: Prep-Phase wenn prepTime > 0
                    if (this.prepTime > 0) {
                        this.isInPrep = true;
                        this.currentTime = this.prepTime;
                        this.currentRepetition = 0;
                    } else {
                        this.currentRepetition = 1;
                        this.currentTime = this.totalTime;
                    }
                }

                this.isRunning = true;
                this.isPaused = false;
                this.lastTickTime = performance.now();
                this.phaseEndTime = Date.now() + this.currentTime * 1000;

                this.requestNotificationPermission();

                if (this.keepScreenActive) {
                    this.requestWakeLock();
                }

                this.startTickInterval();
                this.updateDisplay();
                this.startRingAnimation();
            }

            stop() {
                this.isRunning = false;
                this.isPaused = false;
                this.stopTickInterval();
                this.stopRingAnimation();
                this.releaseWakeLock();
                this.currentRepetition = 0;
                this.currentTime = this.totalTime;
                this.isInBreak = false;
                this.isInPrep = false;
                this.updateDisplay();
            }

            pause() {
                this.isPaused = true;
                this.stopTickInterval();
                this.stopRingAnimation();
                this.updateDisplay();
            }

            resume() {
                this.isPaused = false;
                this.lastTickTime = performance.now();
                this.phaseEndTime = Date.now() + this.currentTime * 1000;
                this.startTickInterval();
                this.updateDisplay();
                this.startRingAnimation();
            }

            startRingAnimation() {
                const animate = () => {
                    this.updateRing();
                    this.animationFrameId = requestAnimationFrame(animate);
                };
                this.animationFrameId = requestAnimationFrame(animate);
            }

            stopRingAnimation() {
                if (this.animationFrameId) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                }
            }

            reset() {
                this.stop();
            }

            tick() {
                const now = Date.now();
                const remainingMs = this.phaseEndTime - now;
                const prevTime = this.currentTime;

                if (remainingMs > 0) {
                    // Noch in der aktuellen Phase
                    this.currentTime = Math.ceil(remainingMs / 1000);
                    this.lastTickTime = performance.now();

                    // Countdown-Beeps in den letzten 3 Sekunden
                    if (this.currentTime > 0 && this.currentTime <= 3 && this.currentTime < prevTime) {
                        this.playSound('countdown');
                    }

                    this.updateDisplay();
                } else {
                    // Phase beendet - weiter zur nächsten Phase
                    this.advancePhase(now);
                }
            }

            advancePhase(now) {
                let phasesSkipped = 0;
                const maxSkips = this.repetitions * 2 + 2;

                while (this.phaseEndTime <= now && this.isRunning && phasesSkipped < maxSkips) {
                    phasesSkipped++;

                    if (this.isInPrep) {
                        // Ende der Vorbereitungszeit - zur ersten Übung
                        this.isInPrep = false;
                        this.currentRepetition = 1;
                        this.phaseEndTime += this.totalTime * 1000;
                    } else if (this.isInBreak) {
                        // Ende der Pause - nächste Übung
                        this.isInBreak = false;
                        this.currentRepetition++;

                        if (this.currentRepetition > this.repetitions) {
                            this.complete();
                            return;
                        }

                        this.phaseEndTime += this.totalTime * 1000;
                    } else {
                        // Ende der Übung
                        if (this.currentRepetition < this.repetitions && this.pauseTime > 0) {
                            this.isInBreak = true;
                            this.phaseEndTime += this.pauseTime * 1000;
                        } else {
                            this.currentRepetition++;

                            if (this.currentRepetition > this.repetitions) {
                                this.complete();
                                return;
                            }

                            this.phaseEndTime += this.totalTime * 1000;
                        }
                    }
                }

                // Ton für die aktuelle Phase abspielen
                if (this.isInBreak) {
                    if (document.hidden) {
                        this.pendingPhaseSound = 'pause';
                        this.showNotification('Pause', `Pause – nächste Übung ${this.currentRepetition + 1} von ${this.repetitions}`);
                    } else {
                        this.playSound('pause');
                    }
                } else if (!this.isInPrep) {
                    if (document.hidden) {
                        this.pendingPhaseSound = 'exercise';
                        this.showNotification('Übung', `Übung ${this.currentRepetition} von ${this.repetitions}`);
                    } else {
                        this.playSound('exercise');
                    }
                }
                this.vibrate();

                const remainingMs = this.phaseEndTime - now;
                this.currentTime = Math.ceil(remainingMs / 1000);
                this.lastTickTime = performance.now();
                this.updateDisplay();
            }

            complete() {
                if (document.hidden) {
                    this.showNotification('Fertig!', 'Alle Übungen abgeschlossen – gut gemacht!');
                }

                this.stop();

                const timerStatus = document.getElementById('timerStatus');
                timerStatus.textContent = 'Fertig! Gut gemacht!';
                timerStatus.style.color = 'var(--accent)';

                setTimeout(() => {
                    timerStatus.textContent = '';
                    timerStatus.style.color = '';
                }, 3000);
            }

            updateDisplay() {
                const startStopBtn = document.getElementById('startStopBtn');
                const pauseResumeBtn = document.getElementById('pauseResumeBtn');
                const countdown = document.getElementById('countdown');
                const timerStatus = document.getElementById('timerStatus');
                const repetitionCounter = document.getElementById('repetitionCounter');

                const minutes = Math.floor(this.currentTime / 60);
                const seconds = this.currentTime % 60;
                countdown.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                countdown.classList.remove('paused', 'in-break', 'pulse');
                timerStatus.classList.remove('in-break');

                if (this.isRunning) {
                    startStopBtn.textContent = 'Stop';
                    startStopBtn.classList.add('running');
                    pauseResumeBtn.disabled = false;

                    if (this.isPaused) {
                        countdown.classList.add('paused');
                        timerStatus.textContent = 'Pausiert';
                        pauseResumeBtn.textContent = 'Fortsetzen';
                    } else if (this.isInPrep) {
                        countdown.classList.add('in-break');
                        timerStatus.textContent = 'Vorbereitung';
                        timerStatus.classList.add('in-break');
                        pauseResumeBtn.textContent = 'Pause';
                    } else if (this.isInBreak) {
                        countdown.classList.add('in-break');
                        timerStatus.textContent = 'Pause';
                        timerStatus.classList.add('in-break');
                        pauseResumeBtn.textContent = 'Pause';
                    } else {
                        timerStatus.textContent = 'Übung';
                        pauseResumeBtn.textContent = 'Pause';

                        if (this.currentTime <= 3 && this.currentTime > 0) {
                            countdown.classList.add('pulse');
                        }
                    }
                } else {
                    startStopBtn.textContent = 'Start';
                    startStopBtn.classList.remove('running');
                    pauseResumeBtn.disabled = true;
                    pauseResumeBtn.textContent = 'Pause';
                    timerStatus.textContent = '';
                }

                repetitionCounter.textContent = `Übung ${this.currentRepetition} / ${this.repetitions}`;

                this.updateRing();
            }

            async requestWakeLock() {
                try {
                    if ('wakeLock' in navigator) {
                        this.wakeLockSentinel = await navigator.wakeLock.request('screen');
                        this.wakeLockSentinel.addEventListener('release', () => {
                            this.wakeLockSentinel = null;
                        });
                    }
                } catch (e) {
                    console.warn('Wake Lock failed:', e);
                }
            }

            releaseWakeLock() {
                if (this.wakeLockSentinel) {
                    this.wakeLockSentinel.release();
                    this.wakeLockSentinel = null;
                }
            }

            async requestNotificationPermission() {
                if (!('Notification' in window)) return;
                if (Notification.permission === 'granted') {
                    this.notificationPermission = 'granted';
                    return;
                }
                if (Notification.permission !== 'denied') {
                    const result = await Notification.requestPermission();
                    this.notificationPermission = result;
                }
            }

            showNotification(title, body) {
                if (this.notificationPermission !== 'granted') return;
                if (!document.hidden) return;
                try {
                    new Notification(title, {
                        body: body,
                        icon: 'assets/icons/icon-192.png',
                        tag: 'timer-phase',
                        renotify: true
                    });
                } catch (e) {
                    // Fallback for environments where Notification constructor fails
                    navigator.serviceWorker?.ready?.then(reg => {
                        reg.showNotification(title, {
                            body: body,
                            icon: 'assets/icons/icon-192.png',
                            tag: 'timer-phase',
                            renotify: true
                        });
                    });
                }
            }

            updateRing() {
                const circleProgress = document.getElementById('circleProgress');

                circleProgress.style.strokeDasharray = `${this.circleCircumference} ${this.circleCircumference}`;

                const currentMaxTime = this.isInPrep ? this.prepTime : (this.isInBreak ? this.pauseTime : this.totalTime);

                let progressPercent;
                if (this.isRunning && !this.isPaused) {
                    // Interpoliere zwischen den Sekunden-Ticks für flüssige Animation
                    const elapsed = (performance.now() - this.lastTickTime) / 1000;
                    const smoothTime = Math.max(0, this.currentTime - elapsed);
                    progressPercent = smoothTime / currentMaxTime;
                } else if (this.isRunning) {
                    progressPercent = this.currentTime / currentMaxTime;
                } else {
                    progressPercent = 1;
                }

                const offset = this.circleCircumference * (1 - progressPercent);
                circleProgress.style.strokeDashoffset = offset;

                // Update circle color classes
                circleProgress.classList.remove('in-break', 'paused');
                if (this.isPaused) {
                    circleProgress.classList.add('paused');
                } else if (this.isInPrep || this.isInBreak) {
                    circleProgress.classList.add('in-break');
                }
            }
        }

        let timerManager;

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            timerManager = new TimerManager();
        });
    </script>
</body>
</html>
